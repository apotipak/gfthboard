{% extends "page_itcontract.html" %}

{% load humanize %}

{% load i18n %}

{% block title %} {% trans 'Manage IT Contract' %} {% endblock %}

{% block content %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0 text-dark">{% trans 'IT Contract' %} </h1>
          </div>
          <div class="col-sm-6">
            <!--
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="/">{% trans 'Main Menu' %}</a></li>
              <li class="breadcrumb-item active">{% trans 'ITcontract Entitlement' %}</li>
            </ol>
            -->
          </div>
        </div>
      </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <div class="row">
          <div class="col-lg-12">
                {% if ITcontractList %}
                <table class="table table-striped table-sm" id="contract_list_table">
                  <thead>
                    <tr>
                      <th scope="col">{% trans 'Dept' %}</th>
                      <th scope="col" style="text-align: left">{% trans 'Vendor' %}</th>
                      <th scope="col" style="text-align: left">{% trans 'Description' %}&nbsp;</th>
                      <th scope="col" style="text-align: left">{% trans 'StartDate' %}&nbsp;</th>
                      <th scope="col">{% trans 'Enddate' %}</th>
                      <th scope="col">&nbsp;</th>
                    </tr>
                  </thead>
                  <tbody>   
                  {% for item in ITcontractList %}
                <tr>                  
                  <td>
                    {% if user_language == "th" %}
                    <h6><b>{{ item.dept }}</b></h6>
                    {% else %}
                    <h6><b>{{ item.dept }}</b></h6>
                    {% endif %}
                  </td>
                  <td>{{item.vendor}}</td>
                  <td>{{item.description}}</td>
                  <td>{{item.start_date|date:"d/m/Y"}}</td>
                  <td>{{item.end_date|date:"d/m/Y"}}</td>

                  <td class='text-right'>
                    <button type='button' onclick='update_item("{{item.id}}")' class='btn btn-info btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-pen fa-xs'></i>&nbsp;</button>
                    <button type='button' onclick='delete_item("{{item.id}}")' class='btn btn-danger btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-trash fa-xs'></i>&nbsp;</button>
                  </td>

                </tr>
                  {% endfor %}
                  </tbody>
                </table>

                {% else %}
                <div class="alert alert-success" role="alert">
                  <i class="fa fa-info-circle"></i>&nbsp;&nbsp;ระบบกำลังทำการปรับปรุงข้อมูล
                </div>                                     
                {% endif %}           
          </div>

      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->


<!-- Adjust Rate modal -->
<div class="modal fade" id="update_modal" tabindex="-1" role="dialog">

  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      
      <div class="modal-header bg-info text-white" style="padding:7px;">
        <h5 class="modal-title" id="exampleModalLongTitle"><i class="fas fa-pen fa-xs text-white"></i>&nbsp;&nbsp;<strong>{% trans 'Edit' %}</strong></h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;&nbsp;</span>
        </button>
      </div>

            
      <div class="modal-body" style="padding:5px 5px 2px 5px;">        

        <div class="col-12 p-0 pt-2 pb-3">

          <form method="post" autocomplete="off" name="contract_list_form">
            {% csrf_token %}
            
            <div class="card-body p-0 pt-2">              
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 100px;"><b>Department</b>&nbsp;&nbsp;</span>
                <input type="text" name="dept" class="form-control rounded-0" id="id_dept">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 100px;"><b>Vendor</b>&nbsp;&nbsp;</span>
                <input type="text" name="vendor" class="form-control rounded-0" id="id_vendor">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 100px;"><b>Description</b>&nbsp;&nbsp;</span>
                <input type="text" name="description" class="form-control rounded-0" id="id_description">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 100px;"><b>Start Date</b>&nbsp;&nbsp;</span>                              
                <input type="text" name="start_date" class="form-control datepicker rounded-0 bg-white" placeholder="" required="" value="{{start_date}}" id="id_start_date" readonly="readonly">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 100px;"><b>End Date</b>&nbsp;&nbsp;</span>
                <input type="text" name="end_date" class="form-control datepicker rounded-0 bg-white" placeholder="" required="" value="{{end_date}}" id="id_end_date" readonly="readonly">
              </div>                              
            </div>

            <input type="hidden" name="it_contract_id" id="id_it_contract_id" value="">

          </form> 

        </div>
      </div>

      <div class="modal-footer" style="padding:5px 5px 5px 0;">
        <button type="button" class="btn btn-secondary btn-md" data-dismiss="modal">&nbsp;&nbsp;{% trans 'Cancel' %}&nbsp;&nbsp;</button>
        <button onclick="save_item()" type="button" class="btn btn-primary btn-md">&nbsp;&nbsp;&nbsp;&nbsp;{% trans 'OK' %}&nbsp;&nbsp;&nbsp;&nbsp;</button>
      </div>

    </div>
  </div>

</div>

{% endblock %}


{% block javascript %}
<script>

$(document).ready( function () {
  
  $("#id_start_date").datepicker({
    dateFormat: "dd/mm/yy",
    changeYear: true,
  }).attr('readonly', 'readonly');

  $("#id_end_date").datepicker({
    dateFormat: "dd/mm/yy",
    changeYear: true,
  }).attr('readonly', 'readonly');

});



var table = $('#contract_list_table').DataTable({
  "paging": true,
  "scrollY": "200px",
  "scrollCollapse": true,
  "lengthChange": false,
  "searching": true,
  "ordering": false,
  "info": false,
  "autoWidth": true,
  "language": {
    search: '<i class="fa fa-filter" aria-hidden="true"></i>',
    searchPlaceholder: 'กรองข้อมูล'
  },
  "columnDefs": [{
    "targets": 5,
    "orderable": false
  }] 
});  


function showLoading() {
  $.LoadingOverlaySetup({
      background      : "rgba(0, 0, 0, 0.5)",
      image           : "/static/img/logo-small.png",        
      imageAnimation  : "1.5s fadein",
      imageColor      : "#ffcc00"
  });
  $.LoadingOverlay("show"); 
}

function update_item(id) {  
  $.ajax({
    url: '{% url "ajax_get_it_contract_item" %}',
    type: 'post',          
    dataType: 'json',
    data: {
      csrfmiddlewaretoken: '{{ csrf_token }}',
      id: id,
    },
    success: function (data) {
      if(data.is_error) {
        alert(data.error_message);
      } else {
        it_contract_id = id;
        dept = data.dept;
        vendor = data.vendor;
        description = data.description;
        start_date = data.start_date;
        end_date = data.end_date;

        $("#id_it_contract_id").val(it_contract_id);
        $("#id_dept").val(dept);
        $("#id_vendor").val(vendor);
        $("#id_description").val(description);
        $("#id_start_date").val(start_date);
        $("#id_end_date").val(end_date);
      }      
    }
  });  
  
  $("#update_modal").modal("show");
}

function delete_item(id) {
  alert("TODO");
  // TODO  
}

function save_item(id) {
  it_contract_id = $("#id_it_contract_id").val();
  dept = $("#id_dept").val();
  vendor = $("#id_vendor").val();
  description = $("#id_description").val();
  start_date = $("#id_start_date").val();
  end_date = $("#id_end_date").val();

  // TODO
  //showLoading();

  $.ajax({
    url: '{% url "ajax_save_it_contract_item" %}',
    type: 'post',          
    dataType: 'json',
    data: {
      csrfmiddlewaretoken: '{{ csrf_token }}',
      it_contract_id: it_contract_id,
      dept: dept,
      vendor: vendor,
      description: description,
      start_date: start_date,
      end_date: end_date,
    },
    success: function (data) {
      if(data.is_error) {        
        $(document).Toasts('create', {
          class: "bg-danger", 
          title: "{% trans 'Error' %}",
          subtitle: '',
          autohide: true,
          delay: 2000,
          body: data.message,
          autoDismiss: true,
          close: true,
          autoremove: true,
        });  
      } else {

        $(document).Toasts('create', {
          class: "bg-success", 
          title: "{% trans 'Success' %}",
          subtitle: '',
          autohide: true,
          delay: 2000,
          body: data.message,
          autoDismiss: true,
          close: true,
          autoremove: true,
        });

        result = "";
        for(i=0;i<data.refresh_it_contract_list.length;i++) {
          it_contract_id = data.refresh_it_contract_list[i]['it_contract_id'];
          result += "<tr>";
          result += "<td><h6><b>" + data.refresh_it_contract_list[i]['dept'] + "</h6></b></td>";
          result += "<td>" + data.refresh_it_contract_list[i]['vendor'] + "</td>";
          result += "<td>" + data.refresh_it_contract_list[i]['description'] + "</td>";
          result += "<td>" + data.refresh_it_contract_list[i]['start_date'] + "</td>";
          result += "<td>" + data.refresh_it_contract_list[i]['end_date'] + "</td>";


          result += "<td class='text-right'>";          
          result += " <button type='button' onclick='update_item(" + it_contract_id + ")' class='btn btn-info btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-pen fa-xs'></i>&nbsp;</button>&nbsp;";
          result += "<button type='button' onclick='delete_item(" + it_contract_id + ")' class='btn btn-danger btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-trash fa-xs'></i>&nbsp;</button></td>";



          result += "</tr>";          
        }

        $('#contract_list_table tbody').html(result);
        $("#update_modal").modal("hide");
      }

      // TODO
      //$.LoadingOverlay("hide");
    }
  });  
  
}


</script>
{% endblock %}