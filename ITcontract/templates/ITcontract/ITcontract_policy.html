{% extends "page_itcontract.html" %}

{% load humanize %}

{% load i18n %}

{% block title %} {% trans 'Manage IT Contract' %} {% endblock %}

{% block content %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0 text-dark">{% trans 'IT Contract' %} </h1>
          </div>
          <div class="col-sm-6">                        
            <ol class="breadcrumb float-sm-right">
              <!--
              <li class="breadcrumb-item"><a href="/">{% trans 'Main Menu' %}</a></li>
              <li class="breadcrumb-item active">{% trans 'ITcontract Entitlement' %}</li>
              -->
              <li>
                <button class="btn btn-outline-info btn-md dropdown-toggle" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fas fa-print fa-sm"></i>&nbsp;&nbsp;Print
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink"> 
                  <span style="font-size: 14px;">
                  <a class="dropdown-item" href="#" onclick="print_document();"><i class="fas fa-desktop text-secondary"></i>&nbsp;&nbsp;Display on screen</a>              
                  
                  
                  <a class="dropdown-item" href="{% url 'export_it_contract_to_excel' %}">&nbsp;<i class="far fa-file-excel text-secondary"></i>&nbsp;&nbsp;&nbsp;Export to Excel</a>


                  </span>
                </div>
                &nbsp;&nbsp;
              </li>

              <li class="breadcrumb-item">
                <button type='button' onclick='open_add_item_modal();' class='btn btn-md btn-success' data-toggle='modal'><b>&nbsp;<i class='fas fa-plus fa-xs'></i>&nbsp;New</b>&nbsp;</button>
              </li>
              
            </ol>            
          </div>
        </div>
      </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <div class="row">
          <div class="col-lg-12">
                <table class="table table-striped table-sm" id="contract_list_table">
                  <thead>
                    <tr>
                      <th scope="col">ID</th>
                      <th scope="col">{% trans 'Deptartment' %}</th>
                      <th scope="col" style="text-align: left">{% trans 'Vendor' %}</th>
                      <th scope="col" style="text-align: left">{% trans 'Description' %}&nbsp;</th>
                      <th scope="col" style="text-align: left" nowrap>{% trans 'Start Date' %}&nbsp;</th>
                      <th scope="col" nowrap>{% trans 'End Date' %}</th>
                      <th scope="col" nowrap>Status</th>
                      <th scope="col" class='text-center'>{% trans 'Attachment' %}</th>
                      <th scope="col" nowrap>{% trans 'Upd By' %}</th>
                      <th scope="col">&nbsp;</th>
                    </tr>
                  </thead>

                  <!-- ironman -->
                  {% if ITcontractList %}
                  <tbody>  
                    {% for item in ITcontractList %}
                    <tr>                  
                      <td>{{item.id}}</td>                      
                      <td>{{item.dept}}</td>
                      <td><a href="#" onclick='edit_item("{{item.id}}")'>{{item.vendor}}</a></td>
                      <td>{{item.description}}</td>                      
                      <td>{{item.start_date|date:"d/m/Y"}}</td>
                      <td>{{item.end_date|date:"d/m/Y"}}</td>

                      {% if item.is_contract_expired %}
                      <td><span class='text-danger'>expired</span></td>
                      {% else %}
                      <td nowrap><span class='text-success'><b>{{item.remaining_day}}</b></span>&nbsp;days</td>
                      {% endif %}

                      {% if item.afile != "" %}
                      <td class='text-center'><i class='fas fa-check fa-xs text-success'></i></td>
                      {% else %}
                      <td class='text-center'><i class='fas fa-times fa-xs text-danger'></i></td>
                      {% endif %}
      
                      <td>{{item.upd_by}}</td>

                      <td class='text-right' nowrap>
                        <button type='button' onclick='edit_item("{{item.id}}")' class='btn btn-info btn-xs' data-toggle='modal'>&nbsp;<i class='fas fa-pen fa-xs'></i>&nbsp;</button>
                        <button type='button' onclick='delete_item("{{item.id}}")' class='btn btn-danger btn-xs' data-toggle='modal'>&nbsp;<i class='fas fa-trash fa-xs'></i>&nbsp;</button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>                
                  {% else %}
                  <tbody>                    
                    <tr>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                      <td>&nbsp;</td>
                    </tr>
                  </tbody>
                  {% endif %}           
                  </table>
          </div>

      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->





<!-- ADD MODAL -->
<div class="modal fade" id="add_modal" tabindex="-1" role="dialog">

  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      
      <div class="modal-header bg-success text-white" style="padding:7px;">
        <h5 class="modal-title"><i class="fas fa-plus fa-xs text-white"></i>&nbsp;&nbsp;<strong>Add new item</strong></h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;&nbsp;</span>
        </button>
      </div>

            
      <div class="modal-body" style="padding:5px 5px 2px 5px;">        

        <form method="post" autocomplete="off" name="add_contract_list_form" id="add_contract_list_form" autocomplete="off" enctype="multipart/form-data">        
        {% csrf_token %}

        <div class="col-12 p-0 pt-2 pb-3">
            
            <div class="card-body p-0 pt-2">              
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Department</b>&nbsp;&nbsp;</span>
                <input type="text" name="dept_add" class="form-control rounded-0" id="id_dept_add" value="IT Department" readonly="">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Vendor Name</b>&nbsp;&nbsp;</span>
                <input type="text" name="vendor_add" class="form-control rounded-0" id="id_vendor_add">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Description</b>&nbsp;&nbsp;</span>
                <input type="text" name="description_add" class="form-control rounded-0" id="id_description_add">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Contact Person</b>&nbsp;&nbsp;</span>
                <input type="text" name="person_add" class="form-control rounded-0" id="id_person_add">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">    
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Email</b>&nbsp;&nbsp;</span>
                <input type="text" name="e_mail_add" class="form-control rounded-0" id="id_e_mail_add">
                <span class="pt-1 pl-3" style="width: 120px;"><b>Phone</b>&nbsp;&nbsp;</span>
                <input type="text" name="tel_add" class="form-control rounded-0" id="id_tel_add">                
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Price</b>&nbsp;&nbsp;</span>
                <input type="number" name="price_add" class="form-control rounded-0" id="id_price_add" value="0.00">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Remark</b>&nbsp;&nbsp;</span>
                <input type="text" name="remark_add" class="form-control rounded-0" id="id_remark_add">
              </div>                              
            </div>


            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Start Date</b>&nbsp;&nbsp;</span>                              
                <input type="text" name="start_date_add" class="form-control datepicker rounded-0 bg-white" placeholder="" required="" value="{{start_date}}" id="id_start_date_add" readonly="readonly">                
                <span class="pt-1 pl-3" style="width: 120px;"><b>End Date</b>&nbsp;&nbsp;</span>
                <input type="text" name="end_date_add" class="form-control datepicker rounded-0 bg-white" placeholder="" required="" value="{{end_date}}" id="id_end_date_add" readonly="readonly">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">
              <div class="input-group col-12 p-0 pl-2">                
                <span class="pt-1" style="width: 120px;"><b>Alert Email</b>&nbsp;&nbsp;</span>
                <input type="text" name="ae_mail_add" class="form-control rounded-0" id="id_ae_mail_add" value="itsupport@guardforce.co.th" readonly="">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">
              <div class="custom-file col-12 pl-20">
                <b>Attached File</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <input type="file" id="id_it_contract_document_add" name="it_contract_document_add">
              </div>              
            </div>

        </div>
      </div>

      <div class="modal-footer" style="padding:5px 5px 5px 0;">        
        <button type="reset" class="btn btn-secondary btn-md" data-dismiss="modal">&nbsp;&nbsp;{% trans 'Cancel' %}&nbsp;&nbsp;</button>
        <button onclick="add_item()" type="button" class="btn btn-primary btn-md">&nbsp;&nbsp;&nbsp;&nbsp;{% trans 'Save' %}&nbsp;&nbsp;&nbsp;&nbsp;</button>
      </div>

      </form> 

    </div>
  </div>

</div>




<!-- EDIT MODAL -->
<div class="modal fade" id="edit_modal" tabindex="-1" role="dialog">

  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      
      <div class="modal-header bg-info text-white" style="padding:7px;">
        <h5 class="modal-title" id="exampleModalLongTitle"><i class="fas fa-pen fa-xs text-white"></i>&nbsp;&nbsp;<strong><span id="edit_item_title">Edit</span></strong></h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;&nbsp;</span>
        </button>
      </div>
            
      <div class="modal-body" style="padding:5px 5px 2px 5px;">        

        <div class="col-12 p-0 pt-2 pb-3">

          <!--<form action="/upload/" method="post" autocomplete="off" id="edit_contract_list_form" name="edit_contract_list_form" enctype="multipart/form-data">-->
          <form method="post" autocomplete="off" name="edit_contract_list_form" id="edit_contract_list_form" autocomplete="off" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="card-body p-0 pt-2">              
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Department</b>&nbsp;&nbsp;</span>
                <input type="text" name="dept_edit" class="form-control rounded-0" id="id_dept_edit" value="IT Department" readonly="">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Vendor Name</b>&nbsp;&nbsp;</span>
                <input type="text" name="vendor_edit" class="form-control rounded-0" id="id_vendor_edit">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Description</b>&nbsp;&nbsp;</span>
                <input type="text" name="description_edit" class="form-control rounded-0" id="id_description_edit">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Contact Person</b>&nbsp;&nbsp;</span>
                <input type="text" name="person_edit" class="form-control rounded-0" id="id_person_edit">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                      
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Email</b>&nbsp;&nbsp;</span>
                <input type="text" name="e_mail_edit" class="form-control rounded-0" id="id_e_mail_edit">
                <span class="pt-1 pl-3" style="width: 120px;"><b>Phone</b>&nbsp;&nbsp;</span>
                <input type="text" name="tel_edit" class="form-control rounded-0" id="id_tel_edit">

              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Price</b>&nbsp;&nbsp;</span>
                <input type="number" name="price_edit" class="form-control rounded-0" id="id_price_edit" value="0">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Remark</b>&nbsp;&nbsp;</span>
                <input type="text" name="remark_edit" class="form-control rounded-0" id="id_remark_edit">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                           
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Start Date</b>&nbsp;&nbsp;</span>                              
                <input type="text" name="start_date_edit" class="form-control datepicker rounded-0 bg-white" placeholder="" required="" value="{{start_date}}" id="id_start_date_edit" readonly="readonly">
                <span class="pt-1 pl-3" style="width: 120px;"><b>End Date</b>&nbsp;&nbsp;</span>
                <input type="text" name="end_date_edit" class="form-control datepicker rounded-0 bg-white" placeholder="" required="" value="{{end_date}}" id="id_end_date_edit" readonly="readonly">

              </div>                              
            </div>

            <div class="card-body p-0 pt-2">                      
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;"><b>Alert Email</b>&nbsp;&nbsp;</span>
                <input type="text" name="ae_mail_edit" class="form-control rounded-0" id="id_ae_mail_edit" value="itsupport@guardforce.co.th" readonly="">
              </div>                              
            </div>

            <div class="card-body p-0 pt-2">
              <div class="custom-file col-12 pl-20">
                <b>Attached File</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <input type="file" id="id_it_contract_document_edit" name="it_contract_document_edit">
              </div>              
            </div>

            <input type="hidden" name="contract_id_edit" id="id_it_contract_id_edit" value="">

            </form> 

            
            <div class="card-body p-0">                      
              <div class="input-group col-12 p-0 pl-2">
                <span class="pt-1" style="width: 120px;">&nbsp;</span>
                <div id="is_attached">
                  <button class='btn btn-info btn-sm' onclick="view_contract_document();"><i class="far fa-file-pdf"></i>&nbsp;&nbsp;View PDF</button>
                </div>

              </div>              
            </div>
                      

        </div>
      </div>

      <div class="modal-footer" style="padding:5px 5px 5px 0;">
        <button type="button" class="btn btn-secondary btn-md" data-dismiss="modal">&nbsp;&nbsp;{% trans 'Cancel' %}&nbsp;&nbsp;</button>
        <button onclick="save_item();" type="button" class="btn btn-primary btn-md">&nbsp;&nbsp;&nbsp;&nbsp;{% trans 'Save' %}&nbsp;&nbsp;&nbsp;&nbsp;</button>
      </div>

    </div>
  </div>

</div>

{% endblock %}


{% block javascript %}
<script>

$(document).ready( function () {

  $("#id_start_date_add").datepicker({
    dateFormat: "dd/mm/yy",
    changeYear: true,
  }).attr('readonly', 'readonly').datepicker("setDate", new Date());

  $("#id_end_date_add").datepicker({
    dateFormat: "dd/mm/yy",
    changeYear: true,
  }).attr('readonly', 'readonly').datepicker("setDate", new Date());

  $("#id_start_date_edit").datepicker({
    dateFormat: "dd/mm/yy",
    changeYear: true,
  }).attr('readonly', 'readonly');

  $("#id_end_date_edit").datepicker({
    dateFormat: "dd/mm/yy",
    changeYear: true,
  }).attr('readonly', 'readonly');



  $('#add_modal').on('hide.bs.modal', function (e) {
    var today = new Date(); 
    var year = today.getFullYear();
    var month = today.getMonth()+1;
    var day = today.getDate();    

    if(month.length==1)
      month = "0" + month;
    if(day.length==1)
      day = "0" + day;
    var default_date = day + "/" + month + "/" + year;

    $("#id_dept_add").val("IT Department");
    $("#id_ae_mail_add").val("itsupport@guardforce.co.th");

    $("#id_vendor_add").val("");
    $("#id_description_add").val("");
    
    $("#id_person_add").val("");
    $("#id_tel_add").val("");
    $("#id_price_add").val(0.00);
    $("#id_email_add").val("");
    $("#id_remark_add").val("");

    $("#id_start_date_add").val(default_date);
    $("#id_end_date_add").val(default_date);
  });            

});

var table = $('#contract_list_table').DataTable({
  "paging": true,
  //"scrollY": "400px",
  "pageLength": 15,
  "scrollCollapse": true,
  "lengthChange": false,
  "searching": true,
  "ordering": true,
  "info": false,
  "autoWidth": true,
  "language": {
    search: '<i class="fa fa-filter" aria-hidden="true"></i>',
    searchPlaceholder: 'กรองข้อมูล'
  },
  "columnDefs": [{
    "targets": 8,
    "orderable": false
  }] 
}); 

$('#edit_modal').on('hidden.bs.modal', function () {    
  $("#id_it_contract_document_edit").val('');
})

$('#add_modal').on('hidden.bs.modal', function () {  
  $("#id_it_contract_document_add").val('');  
})


function view_contract_document() {
    it_contract_id = $("#id_it_contract_id_edit").val();
    window.open("/ITcontract/view_contract_document/" + it_contract_id, "_blank");    
}


function save_item(id) {
  event.preventDefault();

  formData = new FormData();  
  data = new FormData($('#edit_contract_list_form').get(0));

  $.ajax({
    url: '{% url "ajax_save_it_contract_item" %}',
    type: 'post',          
    dataType: 'json',
    data: data,
    cache: false,
    processData: false,
    contentType: false,    
    success: function (data) {
      if(data.is_error) {        
        $(document).Toasts('create', {
          class: "bg-danger", 
          title: "{% trans 'Error' %}",
          subtitle: '',
          autohide: true,
          delay: 2000,
          body: data.message,
          autoDismiss: true,
          close: true,
          autoremove: true,
        });  
      } else {

        $(document).Toasts('create', {
          class: "bg-success", 
          title: "{% trans 'Success' %}",
          subtitle: '',
          autohide: true,
          delay: 2000,
          body: data.message,
          autoDismiss: true,
          close: true,
          autoremove: true,
        });

        result = "";
        for(i=0;i<data.refresh_it_contract_list.length;i++) {
          it_contract_id = data.refresh_it_contract_list[i]['it_contract_id'];
          result += "<tr>";
          result += "<td>" + data.refresh_it_contract_list[i]['it_contract_id'] + "</td>";
          result += "<td>" + data.refresh_it_contract_list[i]['dept'] + "</td>";          
          result += "<td><a href='#' onclick='edit_item(" + it_contract_id + ");'>" + data.refresh_it_contract_list[i]['vendor'] + "</a></td>";
          result += "<td>" + data.refresh_it_contract_list[i]['description'] + "</td>";
          result += "<td nowrap>" + data.refresh_it_contract_list[i]['start_date'] + "</td>";
          result += "<td nowrap>" + data.refresh_it_contract_list[i]['end_date'] + "</td>";



          if(data.refresh_it_contract_list[i]['is_contract_expired']) {
            result += "<td><span class='text-danger'>expired</span></td>";
          } else {
            result += "<td nowrap><span class='text-success'><b>" + data.refresh_it_contract_list[i]['remaining_day'] + "</b></span>&nbsp;days</td>";
          }
          
          if(data.refresh_it_contract_list[i]['is_file_attached'])
            result += "<td class='text-center'><i class='fas fa-check fa-xs text-success'></i></td>";
          else
            result += "<td class='text-center'><i class='fas fa-times fa-xs text-danger'></i></td>";

          result += "<td>" + data.refresh_it_contract_list[i]['upd_by'] + "</td>";

          result += "<td class='text-right' nowrap>";
          result += " <button type='button' onclick='edit_item(" + it_contract_id + ")' class='btn btn-info btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-pen fa-xs'></i>&nbsp;</button>&nbsp;";
          result += "<button type='button' onclick='delete_item(" + it_contract_id + ")' class='btn btn-danger btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-trash fa-xs'></i>&nbsp;</button></td>";
          result += "</tr>";          
        }

        $('#contract_list_table tbody').html(result);
        $("#edit_modal").modal("hide");
      }
    }
  });  
  
}

function add_item() {
  formData = new FormData();  
  data = new FormData($('#add_contract_list_form').get(0));

  $.ajax({
    url: '{% url "ajax_add_it_contract_item" %}',
    type: 'post', 
    dataType: 'json',
    data: data,
    cache: false,
    processData: false,
    contentType: false,    
    success: function (data) {
      if(data.is_error) {        
        $(document).Toasts('create', {
          class: "bg-danger", 
          title: "{% trans 'Error' %}",
          subtitle: '',
          autohide: true,
          delay: 2000,
          body: data.message,
          autoDismiss: true,
          close: true,
          autoremove: true,
        });

      } else {
        $(document).Toasts('create', {
          class: "bg-success", 
          title: "{% trans 'Success' %}",
          subtitle: '',
          autohide: true,
          delay: 2000,
          body: data.message,
          autoDismiss: true,
          close: true,
          autoremove: true,
        });

        result = "";
        for(i=0;i<data.refresh_it_contract_list.length;i++) {
          it_contract_id = data.refresh_it_contract_list[i]['it_contract_id'];
          result += "<tr>";
          result += "<td>" + data.refresh_it_contract_list[i]['it_contract_id'] + "</td>";
          result += "<td>" + data.refresh_it_contract_list[i]['dept'] + "</td>";          
          result += "<td><a href='#' onclick='edit_item(" + it_contract_id + ");'>" + data.refresh_it_contract_list[i]['vendor'] + "</a></td>";          
          result += "<td>" + data.refresh_it_contract_list[i]['description'] + "</td>";
          result += "<td nowrap>" + data.refresh_it_contract_list[i]['start_date'] + "</td>";
          result += "<td nowrap>" + data.refresh_it_contract_list[i]['end_date'] + "</td>";
          
          if(data.refresh_it_contract_list[i]['is_contract_expired']) {
            result += "<td><span class='text-danger'>expired</span></td>";
          } else {
            result += "<td nowrap><span class='text-success'><b>" + data.refresh_it_contract_list[i]['remaining_day'] + "</b></span>&nbsp;days</td>";
          }

          if(data.refresh_it_contract_list[i]['is_file_attached'])
            result += "<td class='text-center'><i class='fas fa-check fa-xs text-success'></i></td>";
          else
            result += "<td class='text-center'><i class='fas fa-times fa-xs text-danger'></i></td>";

          result += "<td>" + data.refresh_it_contract_list[i]['upd_by'] + "</td>";
          result += "<td class='text-right' nowrap>";
          result += " <button type='button' onclick='edit_item(" + it_contract_id + ")' class='btn btn-info btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-pen fa-xs'></i>&nbsp;</button>&nbsp;";
          result += "<button type='button' onclick='delete_item(" + it_contract_id + ")' class='btn btn-danger btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-trash fa-xs'></i>&nbsp;</button></td>";
          result += "</tr>";          
        }

        //$('#contract_list_table tbody').html(result);                    
        
        table.destroy();
        $('#contract_list_table tbody').empty().append(result);        
        table = $('#contract_list_table').DataTable({
          "paging": true,
          "pageLength": 15,
          "scrollCollapse": true,
          "lengthChange": false,
          "searching": true,
          "ordering": true,
          "info": false,
          "autoWidth": true,
          "language": {
            search: '<i class="fa fa-filter" aria-hidden="true"></i>',
            searchPlaceholder: 'กรองข้อมูล'
          },
          "columnDefs": [{
            "targets": 8,
            "orderable": false
          }] 
        }); 
      
        $("#add_modal").modal("hide");

      }      
    }
  });  
}
 

function edit_item(id) {  
  $.ajax({
    url: '{% url "ajax_get_it_contract_item" %}',
    type: 'post',          
    dataType: 'json',
    data: {
      csrfmiddlewaretoken: '{{ csrf_token }}',
      id: id,
    },
    success: function (data) {
      if(data.is_error) {
        alert(data.error_message);
      } else {
        it_contract_id = id;
        dept = data.dept;
        vendor = data.vendor;
        description = data.description;
        person = data.person;
        tel = data.tel;
        price = data.price
        e_mail = data.e_mail
        remark = data.remark
        start_date = data.start_date;
        end_date = data.end_date;
        is_attached = data.attacehed_file;
        attached_file_name = data.attached_file_name;

        $("#id_it_contract_id_edit").val(it_contract_id);
        $("#id_dept_edit").val(dept.trim());
        $("#id_vendor_edit").val(vendor.trim());
        $("#id_description_edit").val(description.trim());
        $("#id_person_edit").val(person.trim());
        $("#id_tel_edit").val(tel.trim());
        $("#id_price_edit").val(price);
        $("#id_e_mail_edit").val(e_mail.trim());
        $("#id_remark_edit").val(remark.trim());
        $("#id_start_date_edit").val(start_date);
        $("#id_end_date_edit").val(end_date);
        $("#edit_item_title").html("Edit #" + id);
        
        if(is_attached) {
          $("#is_attached").html("<button class='btn btn-success btn-sm' onclick='view_contract_document();'><i class='far fa-file-pdf'></i>&nbsp;&nbsp;View contract file</button>");
          $("#is_attached").html("<button class='btn btn-success btn-sm' onclick='view_contract_document();'><i class='far fa-file-pdf'></i>&nbsp;&nbsp;" + attached_file_name + "</button>");
          
        } else {
          $("#is_attached").html("No attached file.");
        }
      }
    }
  });  
  
  $("#edit_modal").modal("show");
}

function delete_item(id) {

  $.confirm({
    title: 'Confirmation',
    type: 'red',
    content: 'ยืนยันการลบรายการสัญญาเลขที่ <b>#' + id + "</b>",
    animation: 'zoom',
    animationBounce: 1.5,
    closeIcon: true,
    boxWidth: '38%',
    useBootstrap: false,        
    buttons: {
      confirm: {
        text: 'ยืนยัน',
        btnClass: 'btn-danger',
          action: function () {                   
            $.ajax({
              url: '{% url "ajax_delete_it_contract_item" %}',
              type: 'post',          
              dataType: 'json',
              data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                it_contract_id: id,
              },
              success: function (data) {
                if(data.is_error) {        
                  $(document).Toasts('create', {
                    class: "bg-danger", 
                    title: "{% trans 'Error' %}",
                    subtitle: '',
                    autohide: true,
                    delay: 2000,
                    body: data.message,
                    autoDismiss: true,
                    close: true,
                    autoremove: true,
                  });  
                } else {

                  $(document).Toasts('create', {
                    class: "bg-success", 
                    title: "{% trans 'Success' %}",
                    subtitle: '',
                    autohide: true,
                    delay: 2000,
                    body: data.message,
                    autoDismiss: true,
                    close: true,
                    autoremove: true,
                  });

                  result = "";
                  for(i=0;i<data.refresh_it_contract_list.length;i++) {
                    it_contract_id = data.refresh_it_contract_list[i]['it_contract_id'];
                    result += "<tr>";
                    result += "<td>" + data.refresh_it_contract_list[i]['it_contract_id'] + "</td>";
                    result += "<td>" + data.refresh_it_contract_list[i]['dept'] + "</td>";                    
                    result += "<td><a href='#' onclick='edit_item(" + it_contract_id + ");'>" + data.refresh_it_contract_list[i]['vendor'] + "</a></td>";
                    result += "<td>" + data.refresh_it_contract_list[i]['description'] + "</td>";
                    result += "<td nowrap>" + data.refresh_it_contract_list[i]['start_date'] + "</td>";
                    result += "<td nowrap>" + data.refresh_it_contract_list[i]['end_date'] + "</td>";

                    if(data.refresh_it_contract_list[i]['is_contract_expired']) {
                      result += "<td><span class='text-danger'>expired</span></td>";
                    } else {
                      result += "<td nowrap><span class='text-success'><b>" + data.refresh_it_contract_list[i]['remaining_day'] + "</b></span>&nbsp;days</td>";
                    }
                    if(data.refresh_it_contract_list[i]['is_file_attached'])
                      result += "<td class='text-center'><i class='fas fa-check fa-xs text-success'></i></td>";
                    else
                      result += "<td class='text-center'><i class='fas fa-times fa-xs text-danger'></i></td>";

                    result += "<td>" + data.refresh_it_contract_list[i]['upd_by'] + "</td>";                    
                    result += "<td class='text-right' nowrap>";          
                    result += " <button type='button' onclick='edit_item(" + it_contract_id + ")' class='btn btn-info btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-pen fa-xs'></i>&nbsp;</button>&nbsp;";
                    result += "<button type='button' onclick='delete_item(" + it_contract_id + ")' class='btn btn-danger btn-xs js-update-contract-service' data-toggle='modal'>&nbsp;<i class='fas fa-trash fa-xs'></i>&nbsp;</button></td>";
                    result += "</tr>";          
                  }

                  $('#contract_list_table tbody').html(result);
                  $("#edit_modal").modal("hide");
                }    
              }
            });
          }
        },
        cancel: {                   
          action: function () {
                    
          }
        }
      }
  });

}

function print_document() {
  var href = "/ITcontract/print-it-contract-report/";
  window.open(href,'_blank');
}

function is_contract_expired() {

  test_date = "15/04/2021";

  var q = new Date();
  var m = q.getMonth()+1;
  var d = q.getDay();
  var y = q.getFullYear();
  var date = new Date(y,m,d);

  mydate = new Date('2011-04-11');

  if(date>mydate)
  {
    alert("greater");
  }
  else
  {
    alert("smaller")
  }  
}

function showLoading() {
  $.LoadingOverlaySetup({
      background      : "rgba(0, 0, 0, 0.5)",
      image           : "/static/img/logo-small.png",        
      imageAnimation  : "1.5s fadein",
      imageColor      : "#ffcc00"
  });
  $.LoadingOverlay("show"); 
}


function open_add_item_modal() {
  $("#add_modal").modal("show");
}

/*
function base64ToBlob(base64, mimetype, slicesize) {
    if (!window.atob || !window.Uint8Array) {
        // The current browser doesn't have the atob function. Cannot continue
        return null;
    }
    mimetype = mimetype || '';
    slicesize = slicesize || 512;
    var bytechars = atob(base64);
    var bytearrays = [];
    for (var offset = 0; offset < bytechars.length; offset += slicesize) {
        var slice = bytechars.slice(offset, offset + slicesize);
        var bytenums = new Array(slice.length);
        for (var i = 0; i < slice.length; i++) {
            bytenums[i] = slice.charCodeAt(i);
        }
        var bytearray = new Uint8Array(bytenums);
        bytearrays[bytearrays.length] = bytearray;
    }
    return new Blob(bytearrays, {type: mimetype});
};
*/

</script>
{% endblock %}